# ç¼–è¯‘é“¾æ¥

## ç¼–è¯‘

ç¤ºä¾‹ä»£ç 

``` C
#include <stdio.h>

int main()
{
    printf("Hello World!\n");
    return 0;
}
```

ç¼–è¯‘å¹¶æ‰§è¡Œ

```bash
$ gcc main.c -o main
$ ./main
Hello World!
$
```

ç”±äºåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œå†…éƒ¨ç›´æ¥å®Œæˆäº†ç¼–è¯‘å’Œé“¾æ¥

## é™æ€é“¾æ¥

ç¤ºä¾‹ä»£ç 

``` C
$ tree
.
â”œâ”€â”€ main.c
â””â”€â”€ math.c

1 directory, 2 files
$ cat main.c
#include <stdio.h>

int add (int a,int b);

int main()
{
        printf("Hello World!\n");
        int result =add(5,5);
        return 0;
}
$ cat math.c
int add(int a,int b)
{
        return a+b;
}
$
```

ä½¿ç”¨`gcc -c`ç¼–è¯‘æºæ–‡ä»¶  
> gcc -c æ˜¯ GCC ç¼–è¯‘å™¨çš„æ ¸å¿ƒå‚æ•°ä¹‹ä¸€ï¼Œæ ¸å¿ƒä½œç”¨æ˜¯ï¼šåªæ‰§è¡Œã€Œé¢„å¤„ç† + ç¼–è¯‘ + æ±‡ç¼–ã€æ­¥éª¤ï¼Œç”ŸæˆäºŒè¿›åˆ¶ç›®æ ‡æ–‡ä»¶ï¼ˆ.oï¼‰ï¼Œä½†ä¸æ‰§è¡Œé“¾æ¥ï¼ˆLinkï¼‰æ­¥éª¤ã€‚

``` bash
$ gcc -c main.c
$ gcc -c math.c
$ tree
.
â”œâ”€â”€ main.c
â”œâ”€â”€ main.o
â”œâ”€â”€ math.c
â””â”€â”€ math.o

1 directory, 4 files
$
```

ç¼–è¯‘é˜¶æ®µï¼Œç¼–è¯‘å™¨ä¼šå°†å¤–éƒ¨å‡½æ•°çš„è·³è½¬åœ°å€è®¾ç½®ä¸º0

``` bash
$ objdump -s -d main.o

main.oï¼š     æ–‡ä»¶æ ¼å¼ elf64-x86-64

Contents of section .text:
 0000 f30f1efa 554889e5 4883ec10 488d0500  ....UH..H...H...
 0010 00000048 89c7e800 000000be 05000000  ...H............
 0020 bf050000 00e80000 00008945 fcb80000  ...........E....
 0030 0000c9c3                             ....
Contents of section .rodata:
 0000 48656c6c 6f20576f 726c6421 00        Hello World!.
Contents of section .comment:
 0000 00474343 3a202855 62756e74 75203133  .GCC: (Ubuntu 13
 0010 2e332e30 2d367562 756e7475 327e3234  .3.0-6ubuntu2~24
 0020 2e303429 2031332e 332e3000           .04) 13.3.0.
Contents of section .note.gnu.property:
 0000 04000000 10000000 05000000 474e5500  ............GNU.
 0010 020000c0 04000000 03000000 00000000  ................
Contents of section .eh_frame:
 0000 14000000 00000000 017a5200 01781001  .........zR..x..
 0010 1b0c0708 90010000 1c000000 1c000000  ................
 0020 00000000 34000000 00450e10 8602430d  ....4....E....C.
 0030 066b0c07 08000000                    .k......

Disassembly of section .text:

0000000000000000 <main>:
   0:   f3 0f 1e fa             endbr64
   4:   55                      push   %rbp
   5:   48 89 e5                mov    %rsp,%rbp
   8:   48 83 ec 10             sub    $0x10,%rsp
   c:   48 8d 05 00 00 00 00    lea    0x0(%rip),%rax        # 13 <main+0x13>
  13:   48 89 c7                mov    %rax,%rdi
  16:   e8 00 00 00 00          call   1b <main+0x1b>
  1b:   be 05 00 00 00          mov    $0x5,%esi
  20:   bf 05 00 00 00          mov    $0x5,%edi
  25:   e8 00 00 00 00          call   2a <main+0x2a>
  2a:   89 45 fc                mov    %eax,-0x4(%rbp)
  2d:   b8 00 00 00 00          mov    $0x0,%eax
  32:   c9                      leave
  33:   c3                      ret
```

å…¶ä¸­`16:   e8 00 00 00 00          call   1b <main+0x1b>`å°±æ˜¯printfçš„åæ±‡ç¼–ç¨‹åºï¼Œ`25:   e8 00 00 00 00          call   2a <main+0x2a>`å°±æ˜¯addå‡½æ•°è°ƒç”¨çš„ä½ç½®  

> å¾ˆæ˜æ˜¾ï¼Œä»–ä»¬çš„è°ƒç”¨åœ°å€éƒ½è¢«è®¾ç½®ä¸º0ï¼Œä¼šåœ¨é“¾æ¥æ—¶è¢«ä¿®æ­£

ä¸ºäº†æ–¹ä¾¿é“¾æ¥æ˜¯å¯ä»¥æ‰¾åˆ°è¿™äº›ä½ç½®ï¼Œåœ¨.textä»£ç å—ä¸­ï¼Œè¿˜å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªé‡å®šä½è¡¨(Relocation Table)

``` bash
$ objdump -r main.o

main.oï¼š     æ–‡ä»¶æ ¼å¼ elf64-x86-64

RELOCATION RECORDS FOR [.text]:
OFFSET           TYPE              VALUE
000000000000000f R_X86_64_PC32     .rodata-0x0000000000000004
0000000000000017 R_X86_64_PLT32    puts-0x0000000000000004
0000000000000026 R_X86_64_PLT32    add-0x0000000000000004


RELOCATION RECORDS FOR [.eh_frame]:
OFFSET           TYPE              VALUE
0000000000000020 R_X86_64_PC32     .text
```

å¾ˆæ˜æ˜¾`0000000000000017 R_X86_64_PLT32    puts-0x0000000000000004`å°±æ˜¯printféœ€è¦è¢«ä¿®è®¢çš„åœ°æ–¹ï¼Œ`0000000000000026 R_X86_64_PLT32    add-0x0000000000000004`å°±æ˜¯addå‡½æ•°éœ€è¦è¢«ä¿®è®¢çš„åœ°æ–¹

ä½¿ç”¨å‘½ä»¤è¿›è¡Œé“¾æ¥ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶

``` bash
$ gcc main.o math.o -o main
chenjindou@compilation-server:~/code/C++$ ./main
Hello World!
chenjindou@compilation-server:~/code/C++$
```

å¦‚æœå¿˜è®°å¢åŠ éœ€è¦é“¾æ¥çš„æ–‡ä»¶

``` bash
$ gcc main.o -o main
/usr/bin/ld: main.o: in function `main':
main.c:(.text+0x26): undefined reference to `add'
collect2: error: ld returned 1 exit status
```

å°±ä¼šç›´æ¥æŠ¥é”™ï¼Œå› ä¸ºç¼–è¯‘å™¨æ‰¾ä¸åˆ°addçš„å®šä¹‰ï¼Œä¼šæŠ¥é”™å¼•ç”¨æœªå®šä¹‰ï¼Œæœ‰äº›ç¼–è¯‘å™¨ä¹Ÿå«åšç¬¦å·æœªå®šä¹‰ã€‚

æˆ‘ä»¬å†å»çœ‹main.oçš„åæ±‡ç¼–ï¼Œå°±å‘ç°`25:   e8 00 00 00 00          call   2a <main+0x2a>`å°±æ˜¯.textåç§»0x26ä½ç½®çš„addæ‰¾ä¸åˆ°å¯¹åº”çš„ç¬¦å·ã€‚

ç°åœ¨çš„ç¼–è¯‘æ—¶ä¸å¸¦è°ƒè¯•ä¿¡æ¯çš„ï¼Œäººå·¥çœ‹å¾ˆéš¾çš„ï¼Œå¯ä»¥ç¼–è¯‘æ—¶å¢åŠ è°ƒè¯•ä¿¡æ¯

``` bash
$ cat -n main.c
     1  #include <stdio.h>
     2
     3  int add (int a,int b);
     4
     5  int main()
     6  {
     7          printf("Hello World!\n");
     8          int result =add(5,5);
     9          return 0;
    10  }
$ gcc -g -c main.c
$ gcc main.o -o main
/usr/bin/ld: main.o: in function `main':
/home/chenjindou/code/C++/main.c:8:(.text+0x26): undefined reference to `add'
collect2: error: ld returned 1 exit status
```

ç„¶åä½¿ç”¨`addr2line`å·¥å…·åˆ†æ

``` bash
$ addr2line -e main.o 0x26
/home/chenjindou/code/C++/main.c:8
```

æ˜ç¡®å‘Šè¯‰ä½ ï¼Œå°±åœ¨main.cçš„ç¬¬8è¡Œ

## åŠ¨æ€é“¾æ¥

ä¸Šé¢é™æ€é“¾æ¥çš„ä¾‹å­ï¼Œ`add`å‡½æ•°æ˜¯åœ¨math.oä¸­ï¼Œä½†æ˜¯printfå°±æ˜¯åŠ¨æ€é“¾æ¥çš„

```bash
$ readelf -d main |grep NEEDED
 0x0000000000000001 (NEEDED)             å…±äº«åº“ï¼š[libc.so.6]
```

ç°åœ¨æˆ‘ä»¬å°†math.cç¼–è¯‘æˆåŠ¨æ€é“¾æ¥åº“

``` bash
$ tree
.
â”œâ”€â”€ main.c
â””â”€â”€ math.c

1 directory, 2 files
$ gcc -shared -fPIC math.c -o libmath.so
$ tree
.
â”œâ”€â”€ libmath.so
â”œâ”€â”€ main.c
â””â”€â”€ math.c

1 directory, 3 files
```

ç°åœ¨ç¼–è¯‘main.c

``` bash
$ gcc main.c -lmath -L./ -o main
```

å…¶ä¸­`-lmath`-lè¡¨ç¤ºè¦åŠ¨æ€é“¾æ¥ï¼Œmathè¡¨ç¤ºlibmath.soï¼Œé»˜è®¤libå’Œ.soçœç•¥ã€‚`-L./`ä¸­-Lè¡¨ç¤ºåŠ¨æ€é“¾æ¥åº“çš„ä½ç½®ï¼Œ./è¡¨ç¤ºå°±åœ¨å½“å‰ç›®å½•

æ‰§è¡Œç¨‹åºï¼Œå‘ç°æŠ¥é”™ï¼Œæ‰¾ä¸åˆ°libmath.soè¿™ä¸ªåŠ¨æ€é“¾æ¥åº“

```bash
$ ./main
./main: error while loading shared libraries: libmath.so: cannot open shared object file: No such file or directory
```

å› ä¸ºlinuxé»˜è®¤åªåœ¨ç³»ç»Ÿç›®å½•`/usr/local/lib`ä¸‹æœç´¢åŠ¨æ€åº“

* ç›´æ¥æŠŠåŠ¨æ€åº“æ”¾åˆ°ç³»ç»Ÿç›®å½•ä¸‹ï¼Œä¸æ–¹ä¾¿ï¼Œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œä¸è¦å»åŠ¨ç³»ç»Ÿç›®å½•
* ä¿®æ”¹ç¯å¢ƒå˜é‡

ä½¿ç”¨`export LD_LIBRARY_PATH="$(pwd)"`æŠŠå½“å‰ç›®å½•å¢åŠ åˆ°`LD_LIBRARY_PATH`ç¯å¢ƒå˜é‡ä¸‹ï¼Œè¿™æ ·å¯æ‰§è¡Œç¨‹åºä¼˜å…ˆåœ¨`LD_LIBRARY_PATH`ç¯å¢ƒå˜é‡ä¸‹çš„ç›®ä¸­å¯»æ‰¾ï¼Œæ‰¾ä¸åˆ°å†å»ç³»ç»Ÿç›®å½•

```bash
$ export LD_LIBRARY_PATH="$(pwd)"
$ ./main
Hello World!
```

è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œç¨‹åºè¿è¡Œæ—¶ï¼Œæœ€å®Œç¾çš„çŠ¶æ€æ˜¯æŠŠåŠ¨æ€é“¾æ¥åº“æ‹·è´åˆ°è‡ªå·±çš„å†…å­˜ç©ºé—´ã€‚ä½†æ˜¯è¿™æ ·å°±å’ŒåŠ¨æ€é“¾æ¥çš„ç†å¿µå†²çªï¼Œå› ä¸ºè¿™æ ·å¤šä¸ªè¿›ç¨‹éƒ½ç”¨åŒä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ï¼Œå…¨éƒ¨æ‹·è´çš„è¯ï¼Œå°±ä¼šæµªè´¹å†…å­˜ç©ºé—´ã€‚æ¯”å¦‚è¿›ç¨‹Aåªç”¨åˆ°äº†åŠ¨æ€é“¾æ¥åº“ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œæ‹·è´å…¶ä»–å‡½æ•°æµªè´¹ã€‚

å®é™…ä¸Šé‡‡ç”¨äº†**å»¶æ—¶åŠ è½½**çš„æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ç”¨åˆ°è¿™ä¸ªå‡½æ•°æ—¶æ‰æ‹·è´ã€‚

åŠ è½½æœºåˆ¶å¯¹æ¯”

| æ®µ | åŠ è½½æ—¶æœº | æœºåˆ¶ |
|----|---------|------|
| **.text** | ç¬¬ä¸€æ¬¡å‡½æ•°è°ƒç”¨æ—¶ | ç¼ºé¡µä¸­æ–­è§¦å‘åŠ è½½ |
| **.rodata** | ç¬¬ä¸€æ¬¡è¯»å–æ—¶ | ç¼ºé¡µä¸­æ–­è§¦å‘åŠ è½½ |
| **.data** | ç¬¬ä¸€æ¬¡è¯»å–/å†™å…¥æ—¶ | ç¼ºé¡µä¸­æ–­+å†™æ—¶å¤åˆ¶ |
| **.bss** | ç¬¬ä¸€æ¬¡è¯»å–/å†™å…¥æ—¶ | ç¼ºé¡µä¸­æ–­åˆ†é…é›¶é¡µ |

> æ¯”å¦‚éœ€è¦åˆ°å‡½æ•°fun()ï¼Œä¸æ˜¯åªæŠŠfun()åŠ è½½èµ°ï¼Œå› ä¸ºlinuxæ˜¯æŒ‰é¡µè®¿é—®çš„ï¼Œä¼šæŠŠåŒ…å«fun()çš„æ‰€æœ‰é¡µå…¨éƒ¨åŠ è½½åˆ°è‡ªå·±è¿›ç¨‹çš„å†…å­˜ç©ºé—´

å»¶è¿ŸåŠ è½½æ ¸å¿ƒ**ä¼˜ç¼ºç‚¹**

âœ… **ä¸»è¦ä¼˜ç‚¹**

| ç±»åˆ« | è¯´æ˜ |
|------|------|
| **å¯åŠ¨å¿«** | åªåŠ è½½å¿…è¦éƒ¨åˆ†ï¼Œç¨‹åºç§’å¼€ |
| **çœå†…å­˜** | å¤šä¸ªè¿›ç¨‹å…±äº«ä»£ç ï¼Œç‰©ç†å†…å­˜å ç”¨å°‘ |
| **çµæ´»** | æ’ä»¶/æ¨¡å—æŒ‰éœ€åŠ è½½ï¼Œæ–¹ä¾¿æ›´æ–° |

âŒ **ä¸»è¦ç¼ºç‚¹**

| ç±»åˆ« | è¯´æ˜ |
|------|------|
| **é¦–æ¬¡å¡é¡¿** | ç¬¬ä¸€æ¬¡è°ƒç”¨å‡½æ•°æœ‰åŠ è½½å»¶è¿Ÿ |
| **æ€§èƒ½ä¸ç¨³** | è¿è¡Œæ—¶ç¼ºé¡µä¸­æ–­å½±å“æµç•…åº¦ |
| **è°ƒè¯•éš¾** | å†…å­˜å¸ƒå±€åŠ¨æ€å˜åŒ–ï¼Œbugéš¾å¤ç° |

ğŸ“Š **ä¸€å¥è¯æ€»ç»“**

**å»¶è¿ŸåŠ è½½ = ç”¨è¿è¡Œæ—¶æ€§èƒ½æ¢å¯åŠ¨é€Ÿåº¦å’Œå†…å­˜æ•ˆç‡**

> linux æ²¡æœ‰ç›´æ¥å¸è½½å•ä¸ªå‡½æ•°çš„æœºåˆ¶ï¼Œä½†æœ‰é—´æ¥çš„å†…å­˜å›æ”¶ç­–ç•¥ã€‚ä½†æ˜¯å­˜åœ¨å†…å­˜å›æ”¶æœºåˆ¶

ğŸ”„ **æŒ‰éœ€ä¿ç•™ vs å†…å­˜å‹åŠ›å›æ”¶**

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è°ƒç”¨ fun()       â”‚â”€â”€â”€>â”‚  é¡µé¢åŠ è½½åˆ°ç‰©ç†å†…å­˜         â”‚â”€â”€â”€>â”‚  æ ‡è®°ä¸ºã€Œå·²è®¿é—®ã€   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  é•¿æ—¶é—´æœªä½¿ç”¨ â†’ é¡µé¢å˜ã€Œä¸æ´»è·ƒã€ â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿå†…å­˜ç´§å¼ æ—¶   â”‚â”€â”€â”€>â”‚  å†…æ ¸è§¦å‘é¡µé¢å›æ”¶æœºåˆ¶        â”‚â”€â”€â”€>â”‚  é‡Šæ”¾è¯¥ç‰©ç†é¡µé¢     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  å†æ¬¡è®¿é—® fun()             â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§¦å‘ç¼ºé¡µä¸­æ–­     â”‚â”€â”€â”€>â”‚  é‡æ–°ä»ç£ç›˜åŠ è½½é¡µé¢åˆ°å†…å­˜    â”‚â”€â”€â”€>â”‚  æ¢å¤ fun() æ‰§è¡Œ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åŠ¨æ€åŠ è½½

### ä»€ä¹ˆæ˜¯åŠ¨æ€åŠ è½½

åŠ¨æ€åŠ è½½æ˜¯ä¸€ç§**è¿è¡Œæ—¶**åŠ è½½å’Œä½¿ç”¨åº“çš„æŠ€æœ¯ï¼Œä¸é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥çš„åŒºåˆ«åœ¨äºï¼š

| åŠ è½½æ–¹å¼ | æ—¶æœº | ç‰¹ç‚¹ |
|---------|------|------|
| **é™æ€é“¾æ¥** | ç¼–è¯‘æ—¶ | åº“ä»£ç è¢«å¤åˆ¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ |
| **åŠ¨æ€é“¾æ¥** | ç¨‹åºå¯åŠ¨æ—¶ | åº“åœ¨ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½ |
| **åŠ¨æ€åŠ è½½** | è¿è¡Œæ—¶ | ç¨‹åºåœ¨è¿è¡Œæ—¶æ ¹æ®éœ€è¦åŠ è½½åº“ |

### æ ¸å¿ƒAPIå‡½æ•°

1.**dlopen()** - æ‰“å¼€åŠ¨æ€åº“

```c
void *dlopen(const char *filename, int flags);
```

- **åŠŸèƒ½**ï¼šæ‰“å¼€æŒ‡å®šåŠ¨æ€åº“
- **å‚æ•°**ï¼š
  - `filename`ï¼šåº“æ–‡ä»¶è·¯å¾„
  - `flags`ï¼šåŠ è½½æ ‡å¿—
    - `RTLD_LAZY`ï¼šå»¶è¿Ÿç»‘å®šï¼ˆæ¨èï¼‰
    - `RTLD_NOW`ï¼šç«‹å³è§£ææ‰€æœ‰ç¬¦å·
    - `RTLD_GLOBAL`ï¼šä½¿ç¬¦å·å…¨å±€å¯ç”¨
- **è¿”å›å€¼**ï¼šåº“å¥æŸ„ï¼ˆå¤±è´¥è¿”å›NULLï¼‰

2.**dlsym()** - è·å–å‡½æ•°/å˜é‡åœ°å€

```c
void *dlsym(void *handle, const char *symbol);
```

- **åŠŸèƒ½**ï¼šä»åº“ä¸­è·å–ç¬¦å·åœ°å€
- **å‚æ•°**ï¼š
  - `handle`ï¼šdlopenè¿”å›çš„å¥æŸ„
  - `symbol`ï¼šå‡½æ•°æˆ–å˜é‡å
- **è¿”å›å€¼**ï¼šç¬¦å·åœ°å€ï¼ˆå¤±è´¥è¿”å›NULLï¼‰

3.**dlerror()** - è·å–é”™è¯¯ä¿¡æ¯

```c
char *dlerror(void);
```

* **åŠŸèƒ½**ï¼šè·å–æœ€è¿‘ä¸€æ¬¡dlå‡½æ•°çš„é”™è¯¯ä¿¡æ¯
- **è¿”å›å€¼**ï¼šé”™è¯¯å­—ç¬¦ä¸²æŒ‡é’ˆ

4.**dlclose()** - å…³é—­åŠ¨æ€åº“

```c
int dlclose(void *handle);
```

* **åŠŸèƒ½**ï¼šå¸è½½åŠ¨æ€åº“
* **å‚æ•°**ï¼šdlopenè¿”å›çš„å¥æŸ„
* **è¿”å›å€¼**ï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›é0

### å·¥ä½œæµç¨‹ç¤ºä¾‹

```c
#include <stdio.h>
#include <dlfcn.h>

int main() {
    void *handle;
    int (*add)(int, int);
    char *error;
    
    // 1. æ‰“å¼€åŠ¨æ€åº“
    handle = dlopen("./libmath.so", RTLD_LAZY);
    if (!handle) {
        fprintf(stderr, "Error: %s\n", dlerror());
        return 1;
    }
    
    // 2. æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
    dlerror();
    
    // 3. è·å–å‡½æ•°åœ°å€
    add = (int (*)(int, int))dlsym(handle, "add");
    error = dlerror();
    if (error != NULL) {
        fprintf(stderr, "Error: %s\n", error);
        dlclose(handle);
        return 1;
    }
    
    // 4. ä½¿ç”¨å‡½æ•°
    int result = add(3, 4);
    printf("3 + 4 = %d\n", result);
    
    // 5. å…³é—­åŠ¨æ€åº“
    dlclose(handle);
    
    return 0;
}
```

### ç¼–è¯‘æ³¨æ„äº‹é¡¹

```bash
# ç¼–è¯‘æ—¶éœ€è¦é“¾æ¥dlåº“
gcc -o program program.c -ldl

# åˆ›å»ºåŠ¨æ€åº“
gcc -fPIC -c math.c -o math.o        # -fPICç”Ÿæˆä½ç½®æ— å…³ä»£ç 
gcc -shared -o libmath.so math.o    # -sharedç”Ÿæˆå…±äº«åº“
```

### åŠ¨æ€åŠ è½½çš„ä¼˜åŠ¿

1.**æŒ‰éœ€åŠ è½½**

```c
// æ’ä»¶ç³»ç»Ÿç¤ºä¾‹
void load_plugin(const char *plugin_name) {
    char lib_path[100];
    snprintf(lib_path, sizeof(lib_path), "./plugins/%s.so", plugin_name);
    
    void *handle = dlopen(lib_path, RTLD_LAZY);
    if (handle) {
        // åŠ è½½æˆåŠŸï¼Œä½¿ç”¨æ’ä»¶åŠŸèƒ½
        // ...
    }
}
```

2.**èµ„æºèŠ‚çœ**

* ä¸å¸¸ç”¨çš„åŠŸèƒ½å¯¹åº”çš„åº“å¯ä»¥å»¶è¿ŸåŠ è½½
* å¯ä»¥éšæ—¶å¸è½½ä¸å†éœ€è¦çš„åº“é‡Šæ”¾å†…å­˜

3.**æ’ä»¶æ¶æ„æ”¯æŒ**

```c
// å®šä¹‰æ’ä»¶æ¥å£
typedef struct {
    void (*init)(void);
    void (*process)(void);
    void (*cleanup)(void);
} Plugin;

// åŠ è½½æ’ä»¶
Plugin* load_plugin(const char *path) {
    void *handle = dlopen(path, RTLD_LAZY);
    if (!handle) return NULL;
    
    Plugin *(*get_plugin)(void) = dlsym(handle, "get_plugin");
    // ...
}
```

4.**çƒ­æ›´æ–°**

```c
// é‡æ–°åŠ è½½æ›´æ–°åçš„åº“
void reload_library(void **handle, const char *path) {
    dlclose(*handle);
    *handle = dlopen(path, RTLD_LAZY);
    // é‡æ–°è·å–å‡½æ•°æŒ‡é’ˆ
    // ...
}
```

### æœ€ä½³å®è·µ

1.**é”™è¯¯å¤„ç†**

```c
void* safe_dlopen(const char *path, int mode) {
    void *handle = dlopen(path, mode);
    if (!handle) {
        fprintf(stderr, "dlopen failed: %s\n", dlerror());
        exit(1);
    }
    return handle;
}
```

2.**ç±»å‹å®‰å…¨çš„å‡½æ•°æŒ‡é’ˆ**

```c
typedef int (*add_func_t)(int, int);
add_func_t add_func = (add_func_t)dlsym(handle, "add");
```

3.**èµ„æºç®¡ç†**

```c
typedef struct {
    void *handle;
    void *symbols[10];
} Library;

void unload_library(Library *lib) {
    if (lib && lib->handle) {
        dlclose(lib->handle);
        lib->handle = NULL;
        memset(lib->symbols, 0, sizeof(lib->symbols));
    }
}
```

### å®é™…åº”ç”¨åœºæ™¯

1.**æ’ä»¶ç³»ç»Ÿ**

```c
// æ•°æ®åº“é©±åŠ¨ç¨‹åºåŠ¨æ€åŠ è½½
void* load_driver(const char *db_type) {
    char driver_path[256];
    snprintf(driver_path, sizeof(driver_path), 
             "/usr/lib/dbdrivers/%s.so", db_type);
    return dlopen(driver_path, RTLD_LAZY);
}
```

2.**æ¨¡å—åŒ–åº”ç”¨**

```c
// æŒ‰éœ€åŠ è½½åŠŸèƒ½æ¨¡å—
void load_module_on_demand(const char *module_name) {
    if (user_requests_module(module_name)) {
        void *module = dlopen(module_name, RTLD_LAZY);
        // åˆå§‹åŒ–æ¨¡å—
        // ...
    }
}
```

3. **å¤šç‰ˆæœ¬æ”¯æŒ**

```c
// æ ¹æ®é…ç½®åŠ è½½ä¸åŒç‰ˆæœ¬çš„åº“
void* load_library_version(const char *base_name, int version) {
    char lib_name[256];
    snprintf(lib_name, sizeof(lib_name),
             "%s_v%d.so", base_name, version);
    return dlopen(lib_name, RTLD_LAZY);
}
```

### æ€»ç»“

åŠ¨æ€åŠ è½½æä¾›äº†æœ€å¤§çš„çµæ´»æ€§ï¼Œç‰¹åˆ«é€‚åˆï¼š

* æ’ä»¶ç³»ç»Ÿ
* å¤§å‹è½¯ä»¶çš„æ¨¡å—åŒ–è®¾è®¡
* éœ€è¦çƒ­æ›´æ–°çš„ç³»ç»Ÿ
* èµ„æºå—é™ç¯å¢ƒä¸­çš„æŒ‰éœ€åŠ è½½

ä½†åŒæ—¶ä¹Ÿå¢åŠ äº†å¤æ‚æ€§ï¼Œéœ€è¦æ›´ä¸¥æ ¼çš„é”™è¯¯å¤„ç†å’Œèµ„æºç®¡ç†ã€‚


### ç¤ºä¾‹ä»£ç  

``` C
#include <stdio.h>
#include <string.h>
#include <dlfcn.h>  // æ·»åŠ åŠ¨æ€åŠ è½½åº“çš„å¤´æ–‡ä»¶

int main()
{
    printf("Hello World!\n");
    printf("Please enter a command (enter 'q' and press Enter to execute the add function, enter 'exit' to quit the program):\n");

    // Buffer to store input
    char input[100];

    void *handle = NULL;        // åŠ¨æ€åº“å¥æŸ„
    int (*add_func)(int, int) = NULL;  // å‡½æ•°æŒ‡é’ˆ
    int library_loaded = 0;     // æ ‡è®°åº“æ˜¯å¦å·²åŠ è½½

    // Infinite loop to monitor input
    while (1) {
        printf("> ");  // Input prompt

        if (fgets(input, sizeof(input), stdin) == NULL) { // Read user input
            printf("Input error!\n"); // Handle input errors
            continue;
        }

        input[strcspn(input, "\n")] = '\0';

        if (strcmp(input, "q") == 0) {
            // å¦‚æœåº“è¿˜æ²¡åŠ è½½ï¼Œå…ˆåŠ è½½åŠ¨æ€åº“
            if (!library_loaded) {
                printf("Loading dynamic library...\n");

                // æ‰“å¼€åŠ¨æ€åº“ï¼ˆæ ¹æ®ä½ çš„åº“åä¿®æ”¹ï¼‰
                handle = dlopen("./libmath.so", RTLD_LAZY);
                if (!handle) {
                    fprintf(stderr, "Failed to load library: %s\n", dlerror());
                    continue;
                }

                // è·å–addå‡½æ•°åœ°å€
                add_func = dlsym(handle, "add");
                char *error = dlerror();
                if (error != NULL) {
                    fprintf(stderr, "Failed to find add function: %s\n", error);
                    dlclose(handle);
                    continue;
                }

                library_loaded = 1;
                printf("Dynamic library loaded successfully.\n");
            }

            printf("start add(5,5)...\n");
            int result = add_func(5, 5);  // é€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨
            printf("end add(5,5)=%d...\n", result);
        }

        else if (strcmp(input, "exit") == 0) { // Exit command
            printf("Exiting program...\n");

            // å…³é—­åŠ¨æ€åº“
            if (library_loaded) {
                dlclose(handle);
                printf("Dynamic library unloaded.\n");
            }

            break;
        }

        else if (strlen(input) > 0) {    // Prompt for unknown input
            printf("Unknown command: %s\n", input);
            printf("Tip: Enter 'q' to execute the add function, enter 'exit' to quit the program\n");
        }
    }

    return 0;
}
```

æ­£ç¡®åŠ è½½åŠ¨æ€é“¾æ¥åº“

``` bash
$ tree
.
â”œâ”€â”€ main.c
â””â”€â”€ math.c

1 directory, 2 files
$ gcc -shared -fPIC math.c -o libmath.so
$ gcc -ldl main.c -o main
$ ./main
Hello World!
Please enter a command (enter 'q' and press Enter to execute the add function, enter 'exit' to quit the program):
> q
Loading dynamic library...
Dynamic library loaded successfully.
start add(5,5)...
end add(5,5)=10...
> exit
Exiting program...
Dynamic library unloaded.
$.
```

å¦‚æœä¿®æ”¹`math.c`å¯¹åº”çš„å‡½æ•°

```C
int add_temp(int a,int b)
{
    return a+b;
}
```

æ‰§è¡Œæ—¶å°±ä¼šæŠ¥é”™

```bash
$ ./main
Hello World!
Please enter a command (enter 'q' and press Enter to execute the add function, enter 'exit' to quit the program):
> q
Loading dynamic library...
Failed to find add function: ./libmath.so: undefined symbol: add
>
>
>
> exit
Exiting program.
```